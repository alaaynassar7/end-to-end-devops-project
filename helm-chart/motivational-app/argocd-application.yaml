name: $(Date:yyyyMMdd)$(Rev:.r)-ArgoCD
trigger: none
pr: none

variables:
  AWS_SERVICE_CONNECTION: 'aws-alaa-2' 
  AWS_REGION: 'eu-north-1' 
  CLUSTER_NAME: 'alaa-devops-project-cluster'
  API_GATEWAY_NAME: 'alaa-devops-project-api'

pool:
  name: 'Self hosted pools'
  demands:
   - Agent.Name -equals alaaynassar-VMware

jobs:
- job: ArgoSync
  displayName: 'ArgoCD Sync / Rollout'
  steps:
  - checkout: self

  - task: AWSShellScript@1
    displayName: Configure kubeconfig
    inputs:
      awsCredentials: $(AWS_SERVICE_CONNECTION)
      regionName: $(AWS_REGION)
      scriptType: inline
      inlineScript: |
        set -e
        aws eks update-kubeconfig --name "$(CLUSTER_NAME)" --region "$(AWS_REGION)"
        
        APIGW_URL=$(aws apigatewayv2 get-apis --query "Items[?Name=='$(API_GATEWAY_NAME)'].ApiEndpoint" --output text)
        if [ -z "$APIGW_URL" ] || [ "$APIGW_URL" == "None" ]; then
           APIGW_URL=$(aws apigatewayv2 get-apis --query "Items[0].ApiEndpoint" --output text)
        fi
        echo "##vso[task.setvariable variable=APIGW_URL]$APIGW_URL"

  - task: Docker@2
    displayName: Docker Login
    inputs:
      command: login
      containerRegistry: 'alaa-docker'

  - task: Bash@3
    displayName: Export Docker Credentials
    inputs:
      targetType: inline
      script: |
        DOCKER_CONFIG=${DOCKER_CONFIG:-$HOME/.docker}
        CONFIG_FILE="$DOCKER_CONFIG/config.json"
        AUTH_STRING=$(python3 -c "import json; data = json.load(open('$CONFIG_FILE')); print(list(data['auths'].values())[0]['auth'])")
        DECODED_AUTH=$(echo "$AUTH_STRING" | base64 -d)
        DOCKER_USERNAME=$(echo "$DECODED_AUTH" | cut -d: -f1)
        DOCKER_PASSWORD=$(echo "$DECODED_AUTH" | cut -d: -f2-)
        echo "##vso[task.setvariable variable=DOCKER_USERNAME]$DOCKER_USERNAME"
        echo "##vso[task.setvariable variable=DOCKER_PASSWORD;isSecret=true]$DOCKER_PASSWORD"

  - task: AWSShellScript@1
    displayName: Deploy Motivational App (Helm)
    inputs:
      awsCredentials: $(AWS_SERVICE_CONNECTION)
      regionName: $(AWS_REGION)
      scriptType: inline
      inlineScript: |
        set -e
        set -x
        
        # 1. Force move to root directory
        cd $(Build.SourcesDirectory)
        
        # 2. Define the exact path
        CHART_PATH="./helm-chart/motivational-app"
        
        # 3. Verify Chart.yaml exists
        if [ ! -f "$CHART_PATH/Chart.yaml" ]; then
            echo "##[error] Chart.yaml NOT found at $CHART_PATH"
            ls -R
            exit 1
        fi

        # 4. Create Namespace and Secrets
        kubectl create namespace alaa --dry-run=client -o yaml | kubectl apply -f -
        kubectl delete secret regcred -n alaa --ignore-not-found=true
        kubectl create secret docker-registry regcred \
          --namespace alaa \
          --docker-server=https://index.docker.io/v1/ \
          --docker-username="$(DOCKER_USERNAME)" \
          --docker-password="$(DOCKER_PASSWORD)" \
          --docker-email=alaaynassar7@gmail.com 

        # 5. Create dynamic values for Cognito/Ingress
        cat <<EOF > dynamic-values.yaml
        ingress:
          annotations:
            nginx.ingress.kubernetes.io/auth-signin: "$(APIGW_URL)/oauth2/start?rd=\$escaped_request_uri"
        EOF

        # 6. CRITICAL FIX: Uninstall old conflicting release first
        # This resolves the exit code 1 issue by cleaning the cluster state
        helm uninstall motivational-app --namespace alaa || echo "No old release to delete"

        # 7. Install/Upgrade with Port 5000 overrides
        helm upgrade --install motivational-app "$CHART_PATH" \
          --namespace alaa \
          --set image.tag="latest" \
          --set service.port=5000 \
          --set service.targetPort=5000 \
          -f dynamic-values.yaml \
          --debug

        # 8. Final Restart
        kubectl rollout restart deployment -n alaa -l app.kubernetes.io/instance=motivational-app
    env:
      DOCKER_PASSWORD: $(DOCKER_PASSWORD)