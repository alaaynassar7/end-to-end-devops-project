trigger: none
pr: none

parameters:
  - name: env
    displayName: "Environment"
    type: string
    default: nonprod
    values: [nonprod, prod]
  - name: action
    displayName: "Terraform Action"
    type: string
    default: plan
    values:
      - plan
      - apply
      - destroy

variables:
  TF_DIR: 'terraform'
  AWS_REGION: 'us-east-1'
  AWS_SERVICE_CONNECTION: 'alaa-aws'

pool:
  vmImage: 'ubuntu-latest'

stages:
  - stage: Infrastructure
    displayName: "Terraform ${{ parameters.action }}"
    jobs:
      - job: TerraformJob
        steps:
          - checkout: self

          # FIX: Manually install Terraform CLI because it's missing on the agent
          - task: Bash@3
            displayName: "Install Terraform CLI"
            inputs:
              targetType: inline
              script: |
                wget -O- https://apt.releases.hashicorp.com/gpg | sudo gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg
                echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/hashicorp.list
                sudo apt update && sudo apt install terraform -y

          # Execute Terraform using AWS Shell Script
          - task: AWSShellScript@1
            displayName: "Terraform Execution"
            inputs:
              awsCredentials: $(AWS_SERVICE_CONNECTION)
              regionName: $(AWS_REGION)
              scriptType: inline
              inlineScript: |
                set -euo pipefail
                cd $(TF_DIR)

                echo "Initializing Terraform..."
                terraform init \
                  -backend-config="bucket=end-to-end-devops-project-bucket" \
                  -backend-config="key=infra/terraform.tfstate" \
                  -backend-config="region=$(AWS_REGION)"

                # Logic for Plan
                if [ "${{ parameters.action }}" == "plan" ]; then
                  echo "Running Terraform Plan..."
                  terraform plan -var-file="${{ parameters.env }}.tfvars"
                
                # Logic for Apply
                elif [ "${{ parameters.action }}" == "apply" ]; then
                  echo "Running Terraform Apply..."
                  terraform apply -var-file="${{ parameters.env }}.tfvars" -auto-approve
                
                # Logic for Destroy
                elif [ "${{ parameters.action }}" == "destroy" ]; then
                  echo "Running Terraform Destroy..."
                  terraform destroy -var-file="${{ parameters.env }}.tfvars" -auto-approve
                fi