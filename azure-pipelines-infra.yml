# ======================================================================================
# Description: Final Infrastructure Pipeline (Using 'alaa-aws' Service Connection)
# Phase: Terraform Provisioning (VPC, EKS, NLB, Route53, Cognito)
# Parameters: Environment (nonprod/prod) and Action (plan/apply/destroy)
# ======================================================================================

parameters:
- name: environment
  displayName: "Environment"
  type: string
  default: nonprod
  values:
  - nonprod
  - prod

- name: terraform_action
  displayName: "Terraform Action"
  type: string
  default: apply
  values:
  - plan
  - apply
  - destroy

trigger:
- main

pool:
  vmImage: 'ubuntu-latest'

variables:
  - name: AWS_REGION
    value: 'us-east-1'
  - name: SERVICE_CONNECTION_NAME
    value: 'alaa-aws' # Updated to match your Service Connection name

stages:
- stage: Terraform_Lifecycle
  displayName: "Infrastructure Management"
  jobs:
  - job: Terraform_Execution
    displayName: "Execute Terraform Actions"
    steps:
    - checkout: self

    # Bridges the 'alaa-aws' Service Connection to the Bash script
    - task: AWSCLI@1
      displayName: 'Terraform: Init, Plan & Execute'
      inputs:
        awsCredentials: $(SERVICE_CONNECTION_NAME)
        regionName: $(AWS_REGION)
        inlineScript: |
          set -e
          # 1. Install Terraform binary (Bypassing external Task dependencies)
          sudo apt-get update && sudo apt-get install -y gnupg software-properties-common
          wget -O- https://apt.releases.hashicorp.com/gpg | gpg --dearmor | sudo tee /usr/share/keyrings/hashicorp-archive-keyring.gpg
          echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/hashicorp.list
          sudo apt-get update && sudo apt-get install terraform

          # 2. Terraform Initialization (Linked to S3 Backend)
          terraform init \
            -backend-config="bucket=end-to-end-devops-project-bucket" \
            -backend-config="key=infra/terraform.tfstate" \
            -backend-config="region=$(AWS_REGION)"

          # 3. Terraform Plan
          echo "Running Plan for ${{ parameters.environment }} environment..."
          terraform plan -var-file="${{ parameters.environment }}.tfvars"

          # 4. Terraform Action (Apply/Destroy)
          if [ "${{ parameters.terraform_action }}" != "plan" ]; then
            echo "Executing ${{ parameters.terraform_action }} on ${{ parameters.environment }}..."
            terraform ${{ parameters.terraform_action }} -var-file="${{ parameters.environment }}.tfvars" -auto-approve
          fi