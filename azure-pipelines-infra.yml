trigger:
- main

parameters:
- name: environment
  displayName: 'Select Environment'
  type: string
  default: 'nonprod'
  values:
  - nonprod
  - prod

- name: terraformAction
  displayName: 'Select Terraform Action'
  type: string
  default: 'plan'
  values:
  - plan
  - apply
  - destroy

pool:
  vmImage: 'ubuntu-latest'

variables:
  AWS_SERVICE_CONNECTION: 'alaa-aws'
  WORKING_DIR: 'terraform'
  BUCKET_NAME: 'end-to-end-devops-project-bucket'
  REGION: 'us-east-1'
  # Set variables based on environment selection
  ${{ if eq(parameters.environment, 'prod') }}:
    STATE_KEY: 'infra/prod/terraform.tfstate'
    VAR_FILE: 'prod.tfvars'
  ${{ if eq(parameters.environment, 'nonprod') }}:
    STATE_KEY: 'infra/nonprod/terraform.tfstate'
    VAR_FILE: 'nonprod.tfvars'

stages:
- stage: TerraformExecution
  displayName: 'Terraform Execution'
  jobs:
  - job: TerraformJob
    steps:
    # 1. Install Terraform (Reliable task)
    - task: TerraformInstaller@1
      displayName: 'Install Terraform'
      inputs:
        terraformVersion: 'latest'

    # 2. Terraform Init, Plan, and Action using AWS CLI for Authentication
    - task: AWSShellScript@1
      displayName: 'Run Terraform Commands'
      inputs:
        awsCredentials: '$(AWS_SERVICE_CONNECTION)'
        regionName: '$(REGION)'
        scriptType: 'inline'
        inlineScript: |
          cd $(WORKING_DIR)
          
          echo "Initializing Terraform for $(parameters.environment)..."
          terraform init \
            -backend-config="bucket=$(BUCKET_NAME)" \
            -backend-config="key=$(STATE_KEY)" \
            -backend-config="region=$(REGION)"
          
          echo "Running Terraform Plan..."
          terraform plan -var-file="$(VAR_FILE)"

          # Execute Apply if selected
          if [ "$(parameters.terraformAction)" == "apply" ]; then
            echo "Executing Terraform Apply..."
            terraform apply -var-file="$(VAR_FILE)" -auto-approve
          fi

          # Execute Destroy if selected
          if [ "$(parameters.terraformAction)" == "destroy" ]; then
            echo "Executing Terraform Destroy..."
            terraform destroy -var-file="$(VAR_FILE)" -auto-approve
          fi