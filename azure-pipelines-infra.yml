name: $(Date:yyyyMMdd)$(Rev:.r)-Infra-Provisioning
trigger: none

# Parameters to select Environment and Action at runtime
parameters:
- name: environment
  displayName: 'Target Environment'
  type: string
  default: 'nonprod'
  values:
  - nonprod
  - prod

- name: terraformAction
  displayName: 'Terraform Action'
  type: string
  default: 'plan'
  values:
  - plan
  - apply
  - destroy

pool:
  name: 'Self hosted pools'
  demands:
   - Agent.Name -equals alaaynassar-VMware 

variables:
  # Global Variables
  AWS_SERVICE_CONNECTION: 'alaa-aws' 
  WORKING_DIR: 'terraform'
  BUCKET_NAME: 'end-to-end-devops-project-bucket'
  REGION: 'us-east-1'
  ACTION_VALUE: ${{ parameters.terraformAction }}
  
  # Dynamic Variables based on Environment Parameter
  ${{ if eq(parameters.environment, 'prod') }}:
    STATE_KEY: 'infra/prod/terraform.tfstate'
    VAR_FILE: 'prod.tfvars'
  ${{ if eq(parameters.environment, 'nonprod') }}:
    STATE_KEY: 'infra/nonprod/terraform.tfstate'
    VAR_FILE: 'nonprod.tfvars'

jobs:
- job: TerraformJob
  displayName: 'Terraform Execution Job'
  steps:
  - checkout: self

  # 1. Install Terraform
  # Purpose: Ensure the specific version of Terraform is available on the agent.
  - task: TerraformInstaller@1
    displayName: 'Install Terraform'
    inputs:
      terraformVersion: 'latest'

  # 2. Run Terraform Commands
  # Purpose: Initialize backend and execute the selected action (Plan/Apply/Destroy).
  - task: AWSShellScript@1
    displayName: 'Terraform Run'
    inputs:
      awsCredentials: '$(AWS_SERVICE_CONNECTION)'
      regionName: '$(REGION)'
      scriptType: 'inline'
      inlineScript: |
        set -euo pipefail
        
        echo "Starting Terraform in $(WORKING_DIR)..."
        cd $(WORKING_DIR)
        
        echo "------------------------------------------------"
        echo "Environment: ${{ parameters.environment }}"
        echo "Action:      $(ACTION_VALUE)"
        echo "State Key:   $(STATE_KEY)"
        echo "------------------------------------------------"

        # Initialize Terraform with Dynamic Backend Configuration
        # This allows switching between Prod and NonProd states dynamically.
        echo "Initializing Terraform..."
        terraform init \
          -backend-config="bucket=$(BUCKET_NAME)" \
          -backend-config="key=$(STATE_KEY)" \
          -backend-config="region=$(REGION)" \
          -reconfigure

        # Execute the selected action
        if [ "$(ACTION_VALUE)" == "plan" ]; then
          echo "Running Terraform Plan..."
          terraform plan -var-file="$(VAR_FILE)"
          
        elif [ "$(ACTION_VALUE)" == "apply" ]; then
          echo "Running Terraform Apply..."
          terraform apply -var-file="$(VAR_FILE)" -auto-approve
          
        elif [ "$(ACTION_VALUE)" == "destroy" ]; then
          echo "Running Terraform Destroy..."
          terraform destroy -var-file="$(VAR_FILE)" -auto-approve
        else
          echo "##[error]Invalid Action selected"
          exit 1
        fi