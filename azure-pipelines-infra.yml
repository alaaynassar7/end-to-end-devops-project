trigger: none

pool:
  vmImage: 'ubuntu-latest'

variables:
  - name: AWS_REGION
    value: 'us-east-1'

# This section brings back the dropdown menu (Plan/Apply/Destroy)
parameters:
- name: terraform_action
  displayName: "Select Terraform Action"
  type: string
  default: plan
  values:
  - plan
  - apply
  - destroy

stages:
- stage: Terraform_Lifecycle
  jobs:
  - job: Terraform_Execution
    steps:
    - checkout: self

    - task: Bash@3
      displayName: 'Install and Execute Terraform'
      inputs:
        targetType: 'inline'
        script: |
          set -e
          
          # Install Terraform CLI
          sudo apt-get update && sudo apt-get install -y gnupg software-properties-common
          wget -O- https://apt.releases.hashicorp.com/gpg | gpg --dearmor | sudo tee /usr/share/keyrings/hashicorp-archive-keyring.gpg
          echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/hashicorp.list
          sudo apt-get update && sudo apt-get install terraform -y

          # Move into the directory
          cd terraform 

          # Initialize with reconfigure
          terraform init -reconfigure \
            -backend-config="bucket=end-to-end-devops-project-bucket" \
            -backend-config="key=infra/terraform.tfstate" \
            -backend-config="region=$(AWS_REGION)"

          # Generate Plan first for safety
          terraform plan -var-file="nonprod.tfvars"

          # Execute the action selected from the menu
          if [ "${{ parameters.terraform_action }}" != "plan" ]; then
            terraform ${{ parameters.terraform_action }} -var-file="nonprod.tfvars" -auto-approve
          fi
      env:
        AWS_ACCESS_KEY_ID: $(AWS_ACCESS_KEY_ID)
        AWS_SECRET_ACCESS_KEY: $(AWS_SECRET_ACCESS_KEY)