trigger: none
pr: none

variables:
  AWS_REGION: 'us-east-1'
  AWS_SERVICE_CONNECTION: 'alaa-aws'

pool:
  vmImage: 'ubuntu-latest'

stages:
  - stage: DeployPlatform
    displayName: "Deploy Platform Tools"
    jobs:
      - job: DeployTools
        displayName: "Helm Bootstrap"
        steps:
          - checkout: self

          # Fetch Cluster Name and VPC ID dynamically to update Kubeconfig
          - task: AWSShellScript@1
            displayName: "Get Cluster Context"
            name: setup
            inputs:
              awsCredentials: $(AWS_SERVICE_CONNECTION)
              regionName: $(AWS_REGION)
              scriptType: inline
              inlineScript: |
                set -euo pipefail
                
                # Dynamic discovery of existing EKS clusters
                CLUSTER_NAME=$(aws eks list-clusters --query 'clusters[0]' --output text)
                
                if [ "$CLUSTER_NAME" == "None" ] || [ -z "$CLUSTER_NAME" ]; then
                  echo "Error: No EKS cluster found. Run Infra Pipeline Apply first."
                  exit 1
                fi
                
                # Extract VPC ID for future controller configurations
                VPC_ID=$(aws eks describe-cluster --name $CLUSTER_NAME --query 'cluster.resourcesVpcConfig.vpcId' --output text)
                
                # Update local Kubeconfig to interact with the cluster
                aws eks update-kubeconfig --region $(AWS_REGION) --name $CLUSTER_NAME
                
                # Pass variables to subsequent tasks in the pipeline
                echo "##vso[task.setvariable variable=CLUSTER_NAME]$CLUSTER_NAME"
                echo "##vso[task.setvariable variable=VPC_ID]$VPC_ID"
                echo "Successfully connected to Cluster: $CLUSTER_NAME"

          # Use Bash to install multiple Helm charts as defined in the plan
          - task: Bash@3
            displayName: "Install Tools (Ingress, ArgoCD, Vault)"
            inputs:
              targetType: inline
              script: |
                set -euo pipefail
                
                # Register official Helm repositories
                helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx
                helm repo add jetstack https://charts.jetstack.io
                helm repo add argo https://argoproj.github.io/argo-helm
                helm repo add hashicorp https://helm.releases.hashicorp.com
                helm repo update

                # Step 4: Install Ingress Controller (Link to NLB)
                echo "Deploying Ingress Nginx..."
                helm upgrade --install ingress-nginx ingress-nginx/ingress-nginx \
                  --namespace ingress-nginx --create-namespace --wait

                # Step 4: Install ArgoCD (GitOps Engine)
                echo "Deploying ArgoCD..."
                helm upgrade --install argocd argo/argo-cd \
                  --namespace argocd --create-namespace --wait

                # Step 4: Install Cert-Manager (SSL Management)
                echo "Deploying Cert-Manager..."
                helm upgrade --install cert-manager jetstack/cert-manager \
                  --namespace cert-manager --create-namespace --set installCRDs=true

                # Step 4: Install Hashicorp Vault (Secrets Management)
                echo "Deploying Vault..."
                helm upgrade --install vault hashicorp/vault \
                  --namespace vault --create-namespace