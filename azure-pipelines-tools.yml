trigger: none
pr: none

variables:
  AWS_REGION: 'us-east-1'
  AWS_SERVICE_CONNECTION: 'alaa-aws'

pool:
  vmImage: 'ubuntu-latest'

stages:
  - stage: DeployPlatform
    displayName: "Deploy Tools via Bash/Helm"
    jobs:
      - job: DeployTools
        steps:
          - checkout: self

          # 1. Install Helm CLI (In case it's not pre-installed)
          - task: Bash@3
            displayName: "Install Helm CLI"
            inputs:
              targetType: inline
              script: |
                curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash

          # 2. Get Cluster Context and Update Kubeconfig
          - task: AWSShellScript@1
            displayName: "Connect to EKS Cluster"
            name: setup
            inputs:
              awsCredentials: $(AWS_SERVICE_CONNECTION)
              regionName: $(AWS_REGION)
              scriptType: inline
              inlineScript: |
                set -euo pipefail
                CLUSTER_NAME=$(aws eks list-clusters --query 'clusters[0]' --output text)
                
                if [ "$CLUSTER_NAME" == "None" ] || [ -z "$CLUSTER_NAME" ]; then
                  echo "Error: No EKS cluster found. Run Infra Apply first."
                  exit 1
                fi
                
                VPC_ID=$(aws eks describe-cluster --name $CLUSTER_NAME --query 'cluster.resourcesVpcConfig.vpcId' --output text)
                aws eks update-kubeconfig --region $(AWS_REGION) --name $CLUSTER_NAME
                
                echo "##vso[task.setvariable variable=CLUSTER_NAME]$CLUSTER_NAME"
                echo "##vso[task.setvariable variable=VPC_ID]$VPC_ID"
                echo "Connected to: $CLUSTER_NAME"

          # 3. Install Tools using Helm Commands directly
          - task: AWSShellScript@1
            displayName: "Install Helm Charts (Bootstrap)"
            inputs:
              awsCredentials: $(AWS_SERVICE_CONNECTION)
              regionName: $(AWS_REGION)
              scriptType: inline
              inlineScript: |
                set -euo pipefail
                
                # Add Repos
                helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx
                helm repo add jetstack https://charts.jetstack.io
                helm repo add argo https://argoproj.github.io/argo-helm
                helm repo add hashicorp https://helm.releases.hashicorp.com
                helm repo update

                # Step 4.1: Install Ingress-Nginx
                echo "Installing Ingress Nginx..."
                helm upgrade --install ingress-nginx ingress-nginx/ingress-nginx \
                  --namespace ingress-nginx --create-namespace --wait

                # Step 4.2: Install ArgoCD
                echo "Installing ArgoCD..."
                helm upgrade --install argocd argo/argo-cd \
                  --namespace argocd --create-namespace --wait

                # Step 4.3: Install Cert-Manager
                echo "Installing Cert-Manager..."
                helm upgrade --install cert-manager jetstack/cert-manager \
                  --namespace cert-manager --create-namespace --set installCRDs=true

                # Step 4.4: Install Vault
                echo "Installing Vault..."
                helm upgrade --install vault hashicorp/vault \
                  --namespace vault --create-namespace