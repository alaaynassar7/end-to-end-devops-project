trigger: none # Manual trigger only

pool:
  vmImage: 'ubuntu-latest'

variables:
  # Replace with your actual AWS Service Connection name in Azure DevOps
  AWS_SERVICE_CONNECTION: 'alaa-aws'
  REGION: 'us-east-1'
  # Ensure this matches your EKS cluster name created by Terraform
  CLUSTER_NAME: 'alaa-devops-project-cluster'

steps:
# Step 1: Checkout the repository
- checkout: self

# Step 2: Install Helm and Kubectl (Required for deploying charts)
- task: HelmInstaller@0
  displayName: 'Install Helm'
  inputs:
    helmVersion: 'latest'
    installKubectl: true

# Step 3: Configure Cluster Access and Install Tools
- task: AWSShellScript@1
  displayName: 'Helm Installs: Nginx, ArgoCD'
  inputs:
    awsCredentials: '$(AWS_SERVICE_CONNECTION)'
    regionName: '$(REGION)'
    scriptType: 'inline'
    inlineScript: |
      echo "--- Step 1: Update Kubeconfig ---"
      # Retrieve kubeconfig to allow kubectl to interact with the EKS cluster
      aws eks update-kubeconfig --region $(REGION) --name $(CLUSTER_NAME)
      
      # Verify connectivity by listing nodes
      kubectl get nodes

      echo "--- Step 2: Install Ingress-Nginx Controller ---"
      # Add the official Ingress-Nginx Helm repository
      helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx
      helm repo update

      # Install Ingress-Nginx.
      # The annotation ensures an AWS Network Load Balancer (NLB) is provisioned.
      helm upgrade --install ingress-nginx ingress-nginx/ingress-nginx \
        --namespace ingress-nginx --create-namespace \
        --set controller.service.annotations."service\.beta\.kubernetes\.io/aws-load-balancer-type"="nlb" \
        --wait

      echo "--- Step 3: Install Argo CD ---"
      # Create a namespace for Argo CD if it doesn't exist
      kubectl create namespace argocd --dry-run=client -o yaml | kubectl apply -f -
      
      # Apply the official Argo CD install manifest
      kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml
      
      echo "Waiting for Argo CD server to be ready..."
      # Wait up to 5 minutes for the Argo CD server pod to be available
      kubectl wait --for=condition=available deployment/argocd-server -n argocd --timeout=300s

      echo "--- Installation Complete ---"

      echo "--- OUTPUT: Load Balancer Hostname ---"
      # Retrieve and print the Load Balancer DNS name.
      # You will need to copy this value for your Terraform 'load_balancer_arn' variable later.
      kubectl get svc ingress-nginx-controller -n ingress-nginx -o jsonpath='{.status.loadBalancer.ingress[0].hostname}'
      echo "" # Print a new line