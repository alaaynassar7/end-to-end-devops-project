trigger: none
pr: none

variables:
  AWS_REGION: 'us-east-1'
  AWS_SERVICE_CONNECTION: 'alaa-aws'

stages:
  - stage: DeployTools
    displayName: 'Deploy Platform Tools'
    jobs:
      - job: InstallHelmCharts
        displayName: 'Install Tools via Helm'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - checkout: self

          # Extract cluster name and update kubeconfig
          - task: AWSShellScript@1
            displayName: 'Setup EKS Context'
            name: setup
            inputs:
              awsCredentials: $(AWS_SERVICE_CONNECTION)
              regionName: $(AWS_REGION)
              scriptType: inline
              inlineScript: |
                set -euo pipefail
                # Dynamically find the cluster created by Terraform
                CLUSTER_NAME=$(aws eks list-clusters --query "clusters[?contains(@, 'alaay-eks')]" --output text)
                
                if [ -z "$CLUSTER_NAME" ] || [ "$CLUSTER_NAME" = "None" ]; then
                  echo "Error: EKS Cluster not found!"
                  exit 1
                fi

                aws eks update-kubeconfig --region $(AWS_REGION) --name $CLUSTER_NAME
                
                # Set variables for subsequent steps
                VPC_ID=$(aws eks describe-cluster --name $CLUSTER_NAME --query 'cluster.resourcesVpcConfig.vpcId' --output text)
                echo "##vso[task.setvariable variable=CLUSTER_NAME]$CLUSTER_NAME"
                echo "##vso[task.setvariable variable=VPC_ID]$VPC_ID"

          # Add required Helm repositories
          - task: Bash@3
            displayName: 'Add Helm Repos'
            inputs:
              targetType: inline
              script: |
                helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx
                helm repo add argo https://argoproj.github.io/argo-helm
                helm repo add hashicorp https://helm.releases.hashicorp.com
                helm repo add external-secrets https://charts.external-secrets.io
                helm repo update

          # Install ArgoCD as the GitOps engine
          - task: HelmDeploy@0
            displayName: 'Install ArgoCD'
            inputs:
              connectionType: 'None'
              namespace: 'argocd'
              command: 'upgrade'
              chartType: 'Name'
              chartName: 'argo/argo-cd'
              releaseName: 'argocd'
              install: true
              arguments: '--create-namespace'

          # Install External Secrets Operator for Vault integration
          - task: HelmDeploy@0
            displayName: 'Install External Secrets'
            inputs:
              connectionType: 'None'
              namespace: 'external-secrets'
              command: 'upgrade'
              chartType: 'Name'
              chartName: 'external-secrets/external-secrets'
              releaseName: 'external-secrets'
              install: true
              arguments: '--create-namespace'